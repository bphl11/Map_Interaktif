<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>INFORMASI SPASIAL BPHL Wilayah XI</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon_bphl_pro_32.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
<!-- SELECT2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

<style>
body { margin:0; font-family: Arial, sans-serif; }
#map { height:100vh; }
#chartOverlay{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    width:90%;
    height:85%;
    background:white;
    border-radius:15px;
    box-shadow:0 10px 40px rgba(0,0,0,0.4);
    padding:20px;
    z-index:2000;
    display:none;

    resize: both;      
    overflow: auto;   
}

#chartOverlay button{
    position:absolute;
    top:10px;
    right:15px;
    background:red;
    color:white;
    border:none;
    border-radius:50%;
    width:30px;
    height:30px;
    cursor:pointer;
}
    .select2-container {
        width:100% !important;
}

.legend {
    background:white;
    padding:10px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    line-height:18px;
    font-size:13px;
}

.legend i {
    width:15px;
    height:15px;
    float:left;
    margin-right:6px;
    opacity:0.7;
}

#dashboardContent {
    overflow-y: auto;
    max-height: 45vh;
}

#dashboardContent table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}

#dashboardContent th {
    background: #2e7d32;
    color: white;
    padding: 4px;
    position: sticky;
    top: 0;
}

#dashboardContent td {
    padding: 4px;
    border: 1px solid #ddd;
}
  /* TOGGLE BUTTON */
#toggleSidebar{
    position:absolute;
    top:20px;
    left:320px;   /* sesuaikan dengan lebar sidebar */
    z-index:2000;

    background:white;
    border:none;
    width:35px;
    height:35px;
    border-radius:8px;
    cursor:pointer;
    font-size:18px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    transition:0.3s;
}

/* Saat sidebar ditutup */
#sidebar.collapsed + #toggleSidebar{
    left:20px;
}
/* SIDEBAR */
#sidebar{
    position:absolute;
    top:0px;
    left:0px;   /* ini saja */
    width:350px;
    height:95vh;

    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);

    border: 1px solid rgba(255,255,255,0.4);
    border-radius:0 15px 15px 0;
    box-shadow:0 15px 30px rgba(0,0,0,0.15);

    padding:15px;
    overflow-y:auto;
    transition:0.3s ease;
    z-index:1000;
}
#dashboardContent{
    margin-top:15px;
    padding:10px;
    background:white;
    border-radius:10px;
    max-height:40vh;
    overflow-y:auto;
}
#sidebar.collapsed{
    transform: translateX(-110%);
}
   .sidebar-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
}
    .logo-area{
    display:flex;
    align-items:center;
    gap:10px;
}
    
.sidebar-header img{
    height:45px;
}

.sidebar-title .main-title{
    font-weight:bold;
    font-size:16px;
    color:#1b5e20;
}

.sidebar-title .sub-title{
    font-size:11px;
    color:#555;
} 
.menu-title{
    font-weight:bold;
    margin-bottom:15px;
    color:#2e7d32;
}

.menu-parent{
    padding:10px;
    background:#f4f6f9;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    margin-top:10px;
}

.menu-child{
    display:none;
    padding:10px 5px;
}

.menu-child div{
    padding:8px;
    cursor:pointer;
    border-radius:6px;
}

.menu-child div:hover{
    background:#e8f5e9;
}

label{
    font-size:12px;
    font-weight:600;
    margin-top:10px;
    display:block;
}
/* RESPONSIVE */
/* ============================= */
/* MOBILE VERSION CLEAN */
/* ============================= */
@media(max-width:768px){

    /* Sidebar jadi full screen */
    #sidebar{
        width:100%;
        height:100vh;
        left:-100%;
        top:0;
        border-radius:0;
        backdrop-filter:none;
        background:white;
        z-index:3000;
    }

    #sidebar.active{
        left:0;
    }

    /* Tombol toggle selalu di kiri atas */
    #toggleSidebar{
        left:15px !important;
        top:15px;
        width:40px;
        height:40px;
        font-size:20px;
    }

    /* Chart full screen */
    #chartOverlay{
        width:100%;
        height:100%;
        top:0;
        left:0;
        transform:none;
        border-radius:0;
        padding:15px;
    }

    #chartOverlay button{
        top:15px;
        right:15px;
    }

    canvas{
        height:80% !important;
    }

    /* Font lebih readable */
    .menu-parent{
        font-size:16px;
    }

    .menu-child div{
        font-size:15px;
        padding:10px;
    }
}
/* =========================
   ROUTING BUTTON MODERN
========================= */

.leaflet-control button {
    transition: all 0.2s ease;
}

.leaflet-control button:hover {
    transform: scale(1.05);
}

.routing-btn {
    background: white;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-size: 18px;
}

.routing-btn.active {
    background: #2e7d32;
    color: white;
    border-color: #2e7d32;
}

.leaflet-routing-container {
    display: none !important;
}

.leaflet-routing-alt {
    display: none !important;
}

.distance-popup {
    font-size: 14px;
    font-weight: 600;
    color: #1565c0;
    text-align: center;
}
</style>
</head>
<body>

<div id="map"></div>
    <div id="chartOverlay">
    <button id="btnCloseChart">‚úñ</button>
    <canvas id="chartKawasan"></canvas>
</div>
<div id="sidebar">

    <div class="sidebar-header">
        <div class="logo-area">
            <img src="logo-kemenhut.png">
            <div class="sidebar-title">
                <div class="main-title">BPHL XI Banjarbaru</div>
                <div class="sub-title">Kementerian Kehutanan RI</div>
            </div>
        </div>
    </div>

    <!-- MONITORING -->
    <div class="menu-group">
        <div class="menu-parent" onclick="toggleMenu(this)">
            üìä Monitoring ‚ñº
        </div>
        <div class="menu-child">
    <div onclick="loadKawasan(); closeSidebarMobile()">Luas Kawasan Hutan</div>
    <div onclick="loadPenanaman(); closeSidebarMobile()">Penanaman PBPH</div>
    <div onclick="loadProduksi(); closeSidebarMobile()">Produksi PBPH</div>
    <div onclick="loadProduksi(); closeSidebarMobile()">Produksi Industri 6000 UP</div>
</div>
    </div>

    <!-- FILTER -->
    <div class="menu-group">
        <div class="menu-parent" onclick="toggleMenu(this)">
            üîé Filter ‚ñº
        </div>
        <div class="menu-child">

            <label>Kabupaten</label>
            <select id="filterKabupaten" multiple></select>

            <label>Kawasan</label>
            <select id="filterF2025" multiple></select>

            <label>PBPH</label>
            <select id="filterNama" multiple></select>

            <label>Industri 6000 UP</label>
            <select id="filterIndustri" multiple></select>

        </div>
    </div>

</div>

<button id="toggleSidebar">‚ò∞</button>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// =======================
// LOAD DATA LUAS KABUPATEN
// =======================

var dataLuasKab = {};

fetch("data_luas_kabupaten.json")
.then(res => res.json())
.then(data => {
    dataLuasKab = data;
    console.log("Data luas kabupaten berhasil dimuat");
});
let chartSemuaInstance = null;

function tampilkanDiagramSemua(){

    let totalHL = 0;
    let totalHP = 0;
    let totalHPK = 0;
    let totalHPT = 0;
    let totalHK = 0;

    for(let kab in dataLuasKab){
        totalHL += dataLuasKab[kab].HL;
        totalHP += dataLuasKab[kab].HP;
        totalHPK += dataLuasKab[kab].HPK;
        totalHPT += dataLuasKab[kab].HPT;
        totalHK += dataLuasKab[kab].HK;
    }

    // Hancurkan chart lama jika ada
    if(chartSemuaInstance){
        chartSemuaInstance.destroy();
    }

    chartSemuaInstance = new Chart(
        document.getElementById("chartSemua"),
        {
            type:'bar',
            data:{
                labels:['HL','HP','HPK','HPT','HK'],
                datasets:[{
                    label:'Total Luas (Ha)',
                    data:[totalHL,totalHP,totalHPK,totalHPT,totalHK]
                }]
            },
            options:{
                responsive:true,
                plugins:{
                    legend:{display:false}
                }
            }
        }
    );
}
// =======================
// BASEMAP
// =======================

var map = L.map('map', {
    zoomControl: false   
}).setView([-3.3,114.6],7);

L.control.zoom({
    position: 'topright'
}).addTo(map);
// =======================
// BASEMAP OSM & SATELIT
// =======================

var osm = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© OpenStreetMap contributors'
});

var satellite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'Tiles ¬© Esri'
});

// Default tampil OSM
osm.addTo(map);

// =======================
// MODE STYLE OTOMATIS
// =======================

// Mode Transparan (Satelit)
function setTransparentMode(){

    pbphLayer.eachLayer(function(layer){
        layer.setStyle({
            weight: 1,
            fillOpacity: 0.12,
            opacity: 0.6
        });
    });

    kawasanLayer.eachLayer(function(layer){
        layer.setStyle({
            weight: 1,
            fillOpacity: 0.12,
            opacity: 0.6
        });
    });
}

// Mode Normal (OSM)
function setNormalMode(){

    pbphLayer.eachLayer(function(layer){
        layer.setStyle(stylePBPH());
    });

    kawasanLayer.eachLayer(function(layer){
        layer.setStyle(styleKawasan(layer.feature));
    });
}

// =======================
// TOGGLE SATELIT MODERN
// =======================

var isSatellite = false;

var satelliteControl = L.control({position:'topright'});

satelliteControl.onAdd = function(map){

    var btn = L.DomUtil.create('button');

    btn.innerHTML = "üõ∞Ô∏è";
    btn.title = "Toggle Citra Satelit";

    btn.style.background = "white";
    btn.style.width = "38px";
    btn.style.height = "38px";
    btn.style.border = "2px solid #ccc";
    btn.style.borderRadius = "8px";
    btn.style.cursor = "pointer";
    btn.style.fontSize = "18px";
    btn.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";

    btn.onclick = function(e){

        L.DomEvent.stopPropagation(e);

        if(!isSatellite){

            map.removeLayer(osm);
            satellite.addTo(map);

            btn.style.background = "#1565c0";
            btn.style.color = "white";

            setTransparentMode();  // üî• Transparan saat satelit

        } else {

            map.removeLayer(satellite);
            osm.addTo(map);

            btn.style.background = "white";
            btn.style.color = "black";

            setNormalMode();       // üî• Normal saat OSM
        }

        isSatellite = !isSatellite;
    };

    return btn;
};

satelliteControl.addTo(map);
// =======================
// FITUR POSISI SAYA
// =======================

var markerLokasi = null;
var circleLokasi = null;

function onLocationFound(e) {

    var radius = e.accuracy;

    if(markerLokasi){
        map.removeLayer(markerLokasi);
        map.removeLayer(circleLokasi);
    }

    markerLokasi = L.marker(e.latlng).addTo(map)
        .bindPopup("üìç Anda berada di sini<br>Akurasi: " + Math.round(radius) + " meter")
        .openPopup();

    circleLokasi = L.circle(e.latlng, radius, {
        color: "#136AEC",
        fillColor: "#136AEC",
        fillOpacity: 0.15
    }).addTo(map);

    map.flyTo(e.latlng, 15);
}

function onLocationError(e) {
    alert("Tidak bisa mendeteksi lokasi: " + e.message);
}

map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);

var locateControl = L.control({position: 'topright'});

locateControl.onAdd = function(map){
    var btn = L.DomUtil.create('button');
    btn.innerHTML = "üìç";
    btn.style.background = "white";
    btn.style.width = "34px";
    btn.style.height = "34px";
    btn.style.border = "2px solid #ccc";
    btn.style.cursor = "pointer";

    btn.onclick = function(){
        map.locate({setView: true, maxZoom: 16});
    };

    return btn;
};

locateControl.addTo(map);

var selectedLayer = null;

// =======================
// STYLE
// =======================

function stylePBPH(){
    return {
        color:"#ff6600",
        weight:2,
        fillColor:"#ff9800",
        fillOpacity:0.5
    };
}

function styleKawasan(feature){
   var warna = {
        "HL":"#02AD00",
        "HP":"#FFFF00",
        "HPT":"#8AF200",
        "HPK":"#FF5EFF",   
        "HK":"#AD3FFF"
    };

    return {
        color:"#2e7d32",
        weight:1,
        fillColor:warna[feature.properties?.F2025] || "#999",
        fillOpacity:0.6
    };
}

// =======================
// HIGHLIGHT
// =======================

function highlightFeature(layer){

    if(selectedLayer){
        selectedLayer.setStyle(selectedLayer.originalStyle);
    }

    layer.originalStyle = {...layer.options};

    layer.setStyle({
        weight:4,
        color:"#000000"
    });

    selectedLayer = layer;

   if(layer.getBounds){
    map.flyToBounds(layer.getBounds(),{
        padding:[40,40],
        duration:0.8
    });
}else if(layer.getLatLng){
    map.flyTo(layer.getLatLng(), 12);
}
}
// =======================
// PBPH LAYER
// =======================

var pbphLayer = L.geoJSON(null,{
    style:stylePBPH,
    onEachFeature:function(feature,layer){

       var props = feature.properties;

var luas = props?.LUAS
    ? Number(props.LUAS).toLocaleString()
    : "0";

var tglSK = "-";
if(props?.TGL_SK){
    var date = new Date(Number(props.TGL_SK));
    tglSK = date.toLocaleDateString("id-ID");
}

layer.bindPopup(
    "<b>"+(props?.NAMOBJ || "-")+"</b><br><br>" +
    "NO SK : " + (props?.NO_SK || "-") + "<br>" +
    "TGL SK : " + tglSK + "<br>" +
    "JENIS : " + (props?.JENIS || "-") + "<br>" +
    "STATUS IZIN : " + (props?.STAT_IZIN || "-") + "<br>" +
    "LUAS : " + luas + " Ha"
);

        layer.on("click",function(){
            highlightFeature(layer);
        });
    }
}).addTo(map);

fetch("pbph.geojson")
.then(res=>res.json())
.then(data=>{
    pbphLayer.addData(data);
    loadNamaOptions(); // isi filter nama setelah data masuk
});

// =======================
// KAWASAN LAYER (GABUNG 2 FILE)
// =======================

var kawasanLayer = L.geoJSON(null,{
    style:styleKawasan,
    onEachFeature:function(feature,layer){
        layer.on("click",function(){
            highlightFeature(layer);
        });
    }
}).addTo(map);

// Load Kawasan Hutan
fetch("Kawasanhutan.geojson")
.then(res=>res.json())
.then(data=>{
    kawasanLayer.addData(data);

    // Setelah file pertama masuk, baru load HK
    return fetch("Konservasi.geojson");
})
.then(res=>res.json())
.then(dataHK=>{

    // Tambahkan properti F2025 = "HK"
    dataHK.features.forEach(function(f){
        f.properties.F2025 = "HK";
    });

    kawasanLayer.addData(dataHK);

    // Load kategori setelah semua masuk
    loadKategoriOptions();
});
// =======================
// INDUSTRI 6000 UP LAYER
// =======================

var industriLayer = L.geoJSON(null,{
    pointToLayer: function(feature, latlng){
        return L.circleMarker(latlng, {
            radius: 6,
            color: "#800000",
            fillColor: "#cc0000",
            fillOpacity: 0.9
        });
    },
    onEachFeature:function(feature,layer){

        var nama = feature.properties?.name;
        
layer.bindPopup("<b>" + nama + "</b>");
       layer.bindTooltip(nama, {
    permanent: true,
    direction: "top",
    offset: [0, -8]
});

        layer.on("click",function(){
            highlightFeature(layer);
        });
    }
}).addTo(map);

fetch("PBPHH_6000_KE_ATAS.geojson")
.then(res=>res.json())
.then(data=>{
    industriLayer.addData(data);
    loadIndustriOptions();
});
// =======================
// TOOLTIP ZOOM CONTROL
// =======================
map.on("zoomend", function() {

    var zoomLevel = map.getZoom();

    industriLayer.eachLayer(function(layer){
        if(zoomLevel >= 12){
            layer.openTooltip();
        } else {
            layer.closeTooltip();
        }
    });

});
// =======================
// KABUPATEN LAYER
// =======================

var kabupatenLayer = L.geoJSON(null,{
    style:{
        color:"#005eff",
        weight:2,
        fillOpacity:0
    },
    onEachFeature:function(feature,layer){

        let namaKab = feature.properties?.KABUPATEN;

        layer.on("click",function(){

            highlightFeature(layer);

            if(dataLuasKab[namaKab]){

                let d = dataLuasKab[namaKab];

                layer.bindPopup(
                    "<b>"+namaKab+"</b><br><br>" +
                    "HL : " + d.HL.toLocaleString() + " Ha<br>" +
                    "HP : " + d.HP.toLocaleString() + " Ha<br>" +
                    "HPK : " + d.HPK.toLocaleString() + " Ha<br>" +
                    "HPT : " + d.HPT.toLocaleString() + " Ha<br>" +
                    "HK : " + d.HK.toLocaleString() + " Ha"
                ).openPopup();
            }
        });
    }
}).addTo(map);

fetch("Kabupaten.geojson")
.then(res=>res.json())
.then(data=>{
    kabupatenLayer.addData(data);
    loadKabupatenOptions();
});
// =======================
// AKTIFKAN SELECT2
// =======================

$('#filterF2025').select2({
    placeholder:"Pilih Kategori"
});

$('#filterNama').select2({
    placeholder:"Pilih Nama PBPH"
});

$('#filterIndustri').select2({
    placeholder:"Pilih Industri 6000 UP"
});
    
$('#filterKabupaten').select2({
    placeholder:"Pilih Kabupaten"
});
// =======================
// LOAD OPTION DINAMIS
// =======================

function loadKategoriOptions(){
    let set = new Set();

    $('#filterF2025').empty(); // supaya tidak dobel

    $('#filterF2025').append(`<option value="ALL">Semua</option>`);

    kawasanLayer.eachLayer(function(layer){
        if(layer.feature.properties?.F2025){
            set.add(layer.feature.properties.F2025);
        }
    });

    set.forEach(val=>{
        $('#filterF2025').append(`<option value="${val}">${val}</option>`);
    });
}

function loadNamaOptions(){
    let set = new Set();

    $('#filterNama').empty(); // TAMBAHAN

    $('#filterNama').append(`<option value="ALL">Semua</option>`);

    pbphLayer.eachLayer(function(layer){
        if(layer.feature.properties?.NAMOBJ){
            set.add(layer.feature.properties.NAMOBJ);
        }
    });

    set.forEach(val=>{
        $('#filterNama').append(`<option value="${val}">${val}</option>`);
    });
}
function loadKabupatenOptions(){

    let set = new Set();

    $('#filterKabupaten').empty();
    $('#filterKabupaten').append(`<option value="ALL">Semua</option>`);

    kabupatenLayer.eachLayer(function(layer){

        let nama = layer.feature.properties?.KABUPATEN;

        if(nama){
            set.add(nama);
        }
    });

    set.forEach(val=>{
        $('#filterKabupaten').append(`<option value="${val}">${val}</option>`);
    });
}
function loadIndustriOptions(){

    let set = new Set();

    $('#filterIndustri').empty();
    $('#filterIndustri').append(`<option value="ALL">Semua</option>`);

    industriLayer.eachLayer(function(layer){

        let nama = layer.feature.properties?.name;

        if(nama){
            set.add(nama);
        }
    });

    set.forEach(val=>{
        $('#filterIndustri').append(`<option value="${val}">${val}</option>`);
    });
}
// =======================
// FILTER FUNCTION
// =======================

function applyFilter(){

     map.closePopup();

    var selectedKategori = $('#filterF2025').val();
    var selectedNama = $('#filterNama').val();
    var selectedKabupaten = $('#filterKabupaten').val();

    var bounds = L.latLngBounds([]);
    var adaZoom = false;

    // =====================
    // FILTER KAWASAN
    // =====================
   kawasanLayer.eachLayer(function(layer){

    var kategori = layer.feature.properties?.F2025;

    if(!selectedKategori || selectedKategori.length === 0){
        map.removeLayer(layer);   // tidak tampil kalau kosong
    }
    else if(selectedKategori.includes("ALL")){
        layer.addTo(map);
    }
    else if(selectedKategori.includes(kategori)){
        layer.addTo(map);
    }
    else{
        map.removeLayer(layer);
    }

});

    // =====================
    // FILTER PBPH
    // =====================
 pbphLayer.eachLayer(function(layer){

    var nama = layer.feature.properties?.NAMOBJ;

    if(!selectedNama || selectedNama.length === 0){
        map.removeLayer(layer);   // tidak tampil kalau kosong
    }
    else if(selectedNama.includes("ALL")){
        layer.addTo(map);
    }
    else if(selectedNama.includes(nama)){
        layer.addTo(map);

        let layerBounds = layer.getBounds();
        if(layerBounds.isValid()){
            bounds.extend(layerBounds);
            adaZoom = true;
        }
    }
    else{
        map.removeLayer(layer);
    }

});
// =====================
// FILTER KABUPATEN
// =====================
kabupatenLayer.eachLayer(function(layer){

    let nama = layer.feature.properties?.KABUPATEN;

    // Jika tidak memilih apa-apa ‚Üí SEMBUNYIKAN
    if(!selectedKabupaten || selectedKabupaten.length === 0){
        map.removeLayer(layer);
    }

    // Jika pilih SEMUA ‚Üí tampilkan semua
    else if(selectedKabupaten.includes("ALL")){
        layer.addTo(map);
    }

    // Jika pilih nama tertentu
    else if(selectedKabupaten.includes(nama)){
        layer.addTo(map);

        let layerBounds = layer.getBounds();
        if(layerBounds.isValid()){
            bounds.extend(layerBounds);
            adaZoom = true;
        }
    }

    else{
        map.removeLayer(layer);
    }

});

/// =====================
// FILTER INDUSTRI 6000 UP
// =====================
var selectedIndustri = $('#filterIndustri').val();

var boundsIndustri = L.latLngBounds([]);

industriLayer.eachLayer(function(layer){

    var nama = layer.feature.properties?.name;

    if(!selectedIndustri || selectedIndustri.length === 0){
        map.removeLayer(layer);
    }

    else if(selectedIndustri.includes("ALL")){
        layer.addTo(map);
        boundsIndustri.extend(layer.getLatLng());

        // AUTO POPUP
        layer.openPopup();
    }

    else if(selectedIndustri.includes(nama)){
        layer.addTo(map);
        boundsIndustri.extend(layer.getLatLng());

        // AUTO POPUP
        layer.openPopup();
    }

    else{
        map.removeLayer(layer);
    }

});
//// =====================
// PRIORITAS ZOOM
// =====================
if(boundsIndustri.isValid()){
    map.flyToBounds(boundsIndustri,{
        padding:[40,40],
        duration:0.8
    });
}
else if(adaZoom && bounds.isValid()){
    map.flyToBounds(bounds,{
        padding:[40,40],
        duration:0.8
    });
}

if(selectedKabupaten && selectedKabupaten.includes("ALL")){
    tampilkanDiagramSemua();
} else {
    
}
    
}
$('#filterF2025').on('change', applyFilter);
$('#filterNama').on('change', applyFilter);
$('#filterKabupaten').on('change', applyFilter);
$('#filterIndustri').on('change', applyFilter);

// =======================
// MENU DASHBOARD DINAMIS
// =======================

let chartInstance = null;

function parseAngka(value){
    if(!value) return 0;
    return parseFloat(
        value.toString()
             .replace(/\./g,'')
             .replace(',', '.')
    ) || 0;
}

// =======================
// LOAD PENANAMAN (DINAMIS TAHUN)
// =======================
function loadPenanaman(){

    document.getElementById("chartOverlay").style.display = "block";

    // Hapus header lama
    let oldTotal = document.getElementById("totalBox");
    if(oldTotal) oldTotal.remove();

    if(chartInstance){
        chartInstance.destroy();
    }

    const spreadsheetID = "1kYvLj9RiXRxZ5rpSvZw8AnNAspngHkY9CMFZKMX_Rno";
    const sheetName = "Penanaman";

    fetch(`https://opensheet.elk.sh/${spreadsheetID}/${sheetName}`)
    .then(res => res.json())
    .then(data => {

        if(!Array.isArray(data) || data.length === 0){
            alert("Data tidak terbaca.");
            return;
        }

// Ambil periode dari C2
const periode = data[0]["Periode"] || "";

// Filter baris kosong
data = data.filter(row => row["Nama PBPH"] && row["Nama PBPH"] !== "");

document.getElementById("chartOverlay").insertAdjacentHTML(
    "afterbegin",
    `<div id="totalBox" 
        style="background:linear-gradient(90deg,#1565c0,#0d47a1);
               color:white;
               padding:10px;
               border-radius:8px;
               margin-bottom:10px;
               font-weight:bold;
               font-size:15px;
               text-align:center">
        üå± PENANAMAN PBPH PERIODE ${periode}
    </div>`
);

        const labels = data.map(r => r["Nama PBPH"]);
        const rencana = data.map(r => parseAngka(r["Rencana"]));
        const realisasi = data.map(r => parseAngka(r["Realisasi"]));

        let totalRencana = rencana.reduce((a,b)=>a+b,0);
        let totalRealisasi = realisasi.reduce((a,b)=>a+b,0);

        labels.push("TOTAL");
        rencana.push(totalRencana);
        realisasi.push(totalRealisasi);

        chartInstance = new Chart(
            document.getElementById("chartKawasan"),
            {
                type:'bar',
                data:{
                    labels: labels,
                    datasets:[
                        {label:'Rencana (Ha)', data:rencana},
                        {label:'Realisasi (Ha)', data:realisasi}
                    ]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{
                        legend:{ position:'top' },
                    },
                    scales:{
                        x:{
                            ticks:{
                                maxRotation:45,
                                minRotation:45,
                                autoSkip:false
                            }
                        },
                        y:{
                            beginAtZero:true
                        }
                    }
                },
                
            }
        );

    })
    .catch(err=>{
        console.log("Error ambil data:", err);
    });
}


// =======================
// LOAD KAWASAN
// =======================
function loadKawasan(){

    document.getElementById("chartOverlay").style.display = "block";

    // Hapus header lama
    let oldTotal = document.getElementById("totalBox");
    if(oldTotal) oldTotal.remove();

    if(chartInstance){
        chartInstance.destroy();
    }

    const spreadsheetID = "1mXXOn8m0jDvTPOnRmSY4rE61u5mUuX21HLyxmtI8lmE";
    const sheetName = "Kawasan";

    fetch(`https://opensheet.elk.sh/${spreadsheetID}/${sheetName}`)
    .then(res => res.json())
    .then(data => {

        const filtered = data.filter(row =>
            row["Kabupaten"] &&
            row["Kabupaten"] !== "Total Luas"
        );

        const labels = filtered.map(r => r["Kabupaten"]);

        const HL  = filtered.map(r => parseAngka(r["HL (Ha)"]));
        const HP  = filtered.map(r => parseAngka(r["HP (Ha)"]));
        const HPK = filtered.map(r => parseAngka(r["HPK (Ha)"]));
        const HPT = filtered.map(r => parseAngka(r["HPT (Ha)"]));
        const HK  = filtered.map(r => parseAngka(r["HK (Ha)"]));

        let totalHL  = HL.reduce((a,b)=>a+b,0);
        let totalHP  = HP.reduce((a,b)=>a+b,0);
        let totalHPK = HPK.reduce((a,b)=>a+b,0);
        let totalHPT = HPT.reduce((a,b)=>a+b,0);
        let totalHK  = HK.reduce((a,b)=>a+b,0);

        document.getElementById("chartOverlay").insertAdjacentHTML(
            "afterbegin",
            `<div id="totalBox" 
                style="background:#e8f5e9;
                       padding:10px;
                       border-radius:8px;
                       margin-bottom:10px;
                       font-weight:bold;
                       font-size:13px">
                TOTAL HL: ${totalHL.toLocaleString()} Ha |
                HP: ${totalHP.toLocaleString()} Ha |
                HPK: ${totalHPK.toLocaleString()} Ha |
                HPT: ${totalHPT.toLocaleString()} Ha |
                HK: ${totalHK.toLocaleString()} Ha
            </div>`
        );

        chartInstance = new Chart(
            document.getElementById("chartKawasan"),
            {
                type:'bar',
                data:{
                    labels: labels,
                    datasets:[
                        {label:'HL',  data:HL},
                        {label:'HP',  data:HP},
                        {label:'HPK', data:HPK},
                        {label:'HPT', data:HPT},
                        {label:'HK',  data:HK}
                    ]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{
                        legend:{ position:'top' }
                    },
                    scales:{
                        x:{ stacked:true },
                        y:{ stacked:true, beginAtZero:true }
                    }
                }
            }
        );

    })
    .catch(err=>{
        console.log("Gagal ambil data:", err);
    });
}
// =======================
// LOAD PRODUKSI KAYU BULAT
// =======================
   function loadProduksi(){

    document.getElementById("chartOverlay").style.display = "block";

    let oldTotal = document.getElementById("totalBox");
    if(oldTotal) oldTotal.remove();

    if(chartInstance){
        chartInstance.destroy();
    }

    const spreadsheetID = "11jcpMuO0i8Nh7cId1loAKYOHn6J9jRSNT3lzmT3t4VU";
    const sheetName = "Produksi%20Kayu%20Bulat";

    fetch(`https://opensheet.elk.sh/${spreadsheetID}/${sheetName}`)
    .then(res => res.json())
    .then(data => {

        if(!Array.isArray(data) || data.length === 0){
            alert("Data Produksi tidak terbaca.");
            return;
        }

       const firstData = data.find(row => row["Periode"] && row["Periode"] !== "");
       const periode = firstData ? firstData["Periode"] : "";
document.getElementById("chartOverlay").insertAdjacentHTML(
    "afterbegin",
    `<div id="totalBox" 
        style="background:linear-gradient(90deg,#2e7d32,#1b5e20);
               color:white;
               padding:10px;
               border-radius:8px;
               margin-bottom:10px;
               font-weight:bold;
               font-size:15px;
               text-align:center">
        üì¶ PRODUKSI KAYU BULAT PBPH PERIODE ${periode}
    </div>`
);

      const labels = data.map(r => r["Nama PBPH"]);
        
const rencana = data.map(r =>
    parseAngka(r["Rencana"])
);

const realisasi = data.map(r =>
    parseAngka(r["Realisasi"])
);

        let totalRencana = rencana.reduce((a,b)=>a+b,0);
        let totalRealisasi = realisasi.reduce((a,b)=>a+b,0);

        labels.push("TOTAL");
        rencana.push(totalRencana);
        realisasi.push(totalRealisasi);

        chartInstance = new Chart(
            document.getElementById("chartKawasan"),
            {
                type:'bar',
                data:{
                    labels: labels,
                    datasets:[
                        {
                            label:'Rencana Volume (m¬≥)',
                            data:rencana
                        },
                        {
                            label:'Realisasi Volume (m¬≥)',
                            data:realisasi
                        }
                    ]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{
                        legend:{ position:'top' }
                    },
                    scales:{
                        x:{
                            ticks:{
                                maxRotation:45,
                                minRotation:45,
                                autoSkip:false
                            }
                        },
                        y:{
                            beginAtZero:true
                        }
                    }
                }
            }
        );

    })
    .catch(err=>{
        console.log("Gagal ambil data Produksi:", err);
    });
}
// =======================
// TOGGLE MENU SIDEBAR
// =======================

function toggleMenu(element){
    let child = element.nextElementSibling;

    if(child.style.display === "block"){
        child.style.display = "none";
    } else {
        child.style.display = "block";
    }
}
function loadSheetData(sheetName){

    const spreadsheetID = "1u9Wx1pUc2M-KzE9997_osg-8NHG5wH4etq4H9am7Rmc";
    const url = `https://opensheet.elk.sh/${spreadsheetID}/${sheetName}`;

    fetch(url)
    .then(res => res.json())
    .then(data => {

        let html = "<table border='1' style='border-collapse:collapse;font-size:12px;width:100%'>";
        
        if(data.length > 0){
            html += "<tr>";
            Object.keys(data[0]).forEach(key=>{
                html += `<th style='padding:4px;background:#eee;'>${key}</th>`;
            });
            html += "</tr>";

            data.forEach(row=>{
                html += "<tr>";
                Object.values(row).forEach(val=>{
                    html += `<td style='padding:4px;'>${val}</td>`;
                });
                html += "</tr>";
            });
        }

        html += "</table>";

        document.getElementById("dashboardContent").innerHTML = html;

    })
    .catch(err=>{
        document.getElementById("dashboardContent").innerHTML =
        "Gagal mengambil data Google Sheet.";
    });
}
// =======================
// COLLAPSIBLE SIDEBAR
// =======================

document.getElementById("toggleSidebar").onclick = function(){

    if(window.innerWidth <= 768){
        document.getElementById("sidebar").classList.toggle("active");
    } else {
        document.getElementById("sidebar").classList.toggle("collapsed");
    }

};
    console.log("Load Kawasan Clicked");
  // =======================
// DRAG CHART OVERLAY
// =======================

const chartOverlay = document.getElementById("chartOverlay");

let isDragging = false;
let offsetX, offsetY;

chartOverlay.addEventListener("mousedown", function(e){

    if(e.target.tagName === "BUTTON") return;

    isDragging = true;
    offsetX = e.clientX - chartOverlay.offsetLeft;
    offsetY = e.clientY - chartOverlay.offsetTop;

    chartOverlay.style.transform = "none";
});

document.addEventListener("mousemove", function(e){
    if(isDragging){
        chartOverlay.style.left = (e.clientX - offsetX) + "px";
        chartOverlay.style.top = (e.clientY - offsetY) + "px";
    }
});

document.addEventListener("mouseup", function(){
    isDragging = false;
});
// =======================
// CLOSE OVERLAY FINAL FIX
// =======================
document.addEventListener("DOMContentLoaded", function(){

    const btnClose = document.getElementById("btnCloseChart");
    const overlay = document.getElementById("chartOverlay");

    if(btnClose){
        btnClose.addEventListener("click", function(){

            // Tutup overlay
            overlay.style.display = "none";

            // Hapus header jika ada
            let oldTotal = document.getElementById("totalBox");
            if(oldTotal) oldTotal.remove();

            // Hancurkan chart supaya bersih
            if(typeof chartInstance !== "undefined" && chartInstance){
                chartInstance.destroy();
                chartInstance = null;
            }

        });
    }

});
// =======================
// CLOSE SIDEBAR MOBILE
// =======================
function closeSidebarMobile(){
    if(window.innerWidth <= 768){
        document.getElementById("sidebar").classList.remove("active");
    }
}
// =======================
// ROUTING MODE PROFESIONAL
// =======================

var routingControl = null;
var routingActive = false;
var routingPoints = [];
var routingBtnElement = null;

// Tombol Toggle Routing
var routingButton = L.control({position:'topright'});

routingButton.onAdd = function(map){

    var btn = L.DomUtil.create('button','routing-btn');

    routingBtnElement = btn;

    btn.innerHTML = "üß≠";
    btn.title = "Aktifkan Routing";

    btn.onclick = function(e){

        L.DomEvent.stopPropagation(e);

        routingActive = !routingActive;

        btn.classList.toggle("active");

        if(routingActive){
            L.popup()
                .setLatLng(map.getCenter())
                .setContent("Klik titik A lalu titik B")
                .openOn(map);
        } else {
            resetRouting();
        }
    };

    return btn;
};

routingButton.addTo(map);

// Klik Map untuk A ‚Üí B
map.on('click', function(e){

    if(!routingActive) return;

    routingPoints.push(e.latlng);

    if(routingPoints.length === 2){

        if(routingControl){
            map.removeControl(routingControl);
        }

        routingControl = L.Routing.control({
            waypoints: routingPoints,
            routeWhileDragging: false,
            show: false,
            addWaypoints: false,
            lineOptions:{
                styles:[{color:'#1565c0', weight:5}]
            }
        }).addTo(map);

        routingControl.on('routesfound', function(e){

            var route = e.routes[0];
            var distance = (route.summary.totalDistance / 1000).toFixed(2);
            var lastCoord = route.coordinates[route.coordinates.length - 1];

            L.popup()
                .setLatLng([lastCoord.lat, lastCoord.lng])
                .setContent("üìè Jarak: <b>" + distance + " km</b>")
                .openOn(map);
        });

        routingPoints = []; // reset agar bisa klik lagi
    }
});

// =======================
// RESET ROUTING FUNCTION
// =======================

function resetRouting(){

    if(routingControl){
        map.removeControl(routingControl);
        routingControl = null;
    }

    routingPoints = [];
    routingActive = false;

    if(routingBtnElement){
        routingBtnElement.classList.remove("active");
    }

    map.closePopup();
}
</script>
</body>
</html>




